<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiliulou.electricity.mapper.ElectricityCabinetBoxMapper">

    <!--查询指定行数据-->
    <select id="queryList" resultType="com.xiliulou.electricity.vo.ElectricityCabinetBoxVO">
        select
        id, electricity_cabinet_id, cell_no, sn, usable_status,
        status,is_lock,is_fan,temperature,is_heat,is_light, create_time,
        update_time,
        del_flag,tenant_id,temperature,battery_type,charge_v,charge_a,version,lock_type,empty_grid_start_time
        from t_electricity_cabinet_box
        where del_flag=0
        <if test="query.electricityCabinetId != null">
            and electricity_cabinet_id = #{query.electricityCabinetId}
        </if>
        <if test="query.tenantId != null ">
            and tenant_id = #{query.tenantId}
        </if>
        order by -cell_no DESC
        limit #{query.offset}, #{query.size}
    </select>
    
    <select id="selectBoxList" resultType="com.xiliulou.electricity.vo.ElectricityCabinetBoxVO">
        select
        ecb.id, ecb.electricity_cabinet_id, ecb.cell_no, ecb.sn, ecb.usable_status,ecb.is_battery_exit ,
        ecb.status,ecb.is_lock,ecb.is_fan,ecb.temperature,ecb.is_heat,ecb.is_light, ecb.create_time,
        ecb.update_time, ecb.del_flag,ecb.tenant_id,ecb.temperature,ecb.battery_type,ecb.charge_v,ecb.charge_a,ecb.version,ecb.lock_type,
        bop.lock_reason,bop.remark,bop.lock_status_change_time,empty_grid_start_time
        from t_electricity_cabinet_box as ecb
        left join t_box_other_properties bop on ecb.electricity_cabinet_id=bop.electricity_cabinet_id and ecb.cell_no=bop.cell_no and ecb.usable_status=1
        where ecb.del_flag=0
        <if test="query.electricityCabinetId != null">
            and ecb.electricity_cabinet_id = #{query.electricityCabinetId}
        </if>
        <if test="query.tenantId != null ">
            and ecb.tenant_id = #{query.tenantId}
        </if>
        limit #{query.offset}, #{query.size}
    </select>
    
    <select id="queryElectricityBatteryBox" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select
        id, electricity_cabinet_id, cell_no, sn, usable_status,power,
        status,is_lock,is_fan,temperature,is_heat,is_light, create_time,
        update_time, del_flag,tenant_id,temperature,battery_type,charge_v
        from t_electricity_cabinet_box
        where del_flag=0 AND electricity_cabinet_id=#{id}
        and status=0 and usable_status=0 and is_lock = 1
        <if test="fullCharged != null">
            and power >= #{fullCharged}
        </if>
        <if test="cellNo != null ">
            and cell_no != #{cellNo}
        </if>
        <if test="batteryType != null ">
            and battery_type = #{batteryType}
        </if>
    </select>


    <update id="batchDeleteBoxByElectricityCabinetId">
        update t_electricity_cabinet_box
        set del_flag    = 1,
            update_time = #{updateTime}
        where electricity_cabinet_id = #{id}
    </update>


    <update id="modifyByCellNo">
        update t_electricity_cabinet_box
        set sn = #{sn},
        empty_grid_start_time = #{emptyGridStartTime},
        <if test="status!= null ">
            status = #{status},
        </if>
        <if test="chargeV != null">
            charge_v= #{chargeV},
        </if>
        <if test="chargeA != null">
            charge_a= #{chargeA},
        </if>
        <if test="reportTime != null">
            report_time= #{reportTime},
        </if>
        b_id = #{bId},
        update_time = #{updateTime},
        battery_type = #{batteryType},
        power = #{power}
        where cell_no = #{cellNo}
        and electricity_cabinet_id = #{electricityCabinetId}
        and del_flag=0
    </update>


    <update id="modifyCellByCellNo">
        update t_electricity_cabinet_box
        <set>
            <if test="usableStatus!= null ">
                usable_status = #{usableStatus},
            </if>
            <if test="status!= null ">
                status = #{status},
            </if>
            <if test="isLock!= null ">
                is_lock = #{isLock},
            </if>
            <if test="isFan!= null ">
                is_fan = #{isFan},
            </if>
            <if test="temperature!= null ">
                temperature = #{temperature},
            </if>
            <if test="isHeat!= null ">
                is_heat = #{isHeat},
            </if>
            <if test="isLight!= null ">
                is_light = #{isLight},
            </if>
            <if test="updateTime!= null ">
                update_time = #{updateTime},
            </if>
            <if test="chargeV != null">
                charge_v= #{chargeV},
            </if>
            <if test="bId != null">
                b_id = #{bId},
            </if>
            <if test="lockType != null">
                lock_type = #{lockType},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="emptyGridStartTime != null">
                empty_grid_start_time = #{emptyGridStartTime},
            </if>
            <if test="isBatteryExit != null">
                is_battery_exit = #{isBatteryExit},
            </if>
        </set>
        where cell_no = #{cellNo}
        and electricity_cabinet_id = #{electricityCabinetId}
        and del_flag=0
    </update>

    <select id="queryUsableBatteryCellNo" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select
        id, electricity_cabinet_id, cell_no, sn, usable_status,
        status,is_lock,is_fan,temperature,is_heat,is_light, create_time,
        update_time, del_flag,tenant_id,temperature,battery_type,power,charge_v,b_id
        from t_electricity_cabinet_box
        <where>
            electricity_cabinet_id = #{eid}
            and usable_status = 0
            and del_flag = 0
            and status = 0
            and is_lock = 1
            and power &gt;= #{fullV}
            <if test="type != null and type!= ''">
                and battery_type = #{type}
            </if>
        </where>
        order by power desc
    </select>
    
    <select id="queryUsableEmptyCellNo" resultType="com.xiliulou.electricity.query.FreeCellNoQuery">
        select
        cell_no, empty_grid_start_time
        from t_electricity_cabinet_box
        <where>
            electricity_cabinet_id = #{eid}
            and usable_status = 0
            and del_flag = 0
            and status = 1
        </where>
        order by cell_no desc
    </select>
    
    <select id="selectUsableEmptyCell" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select
        id, electricity_cabinet_id, cell_no, usable_status, status,is_lock
        from t_electricity_cabinet_box
        <where>
            electricity_cabinet_id = #{eid}
            and usable_status = 0
            and del_flag = 0
            and status = 1
        </where>
    </select>
    
    <select id="selectUsableEmptyCellNumber" resultType="int">
        select count(1)
        from t_electricity_cabinet_box
        <where>
            electricity_cabinet_id = #{eid}
            and tenant_id=#{tenantId}
            and usable_status = 0
            and del_flag = 0
            and status = 1
        </where>
        order by cell_no desc
    </select>
    
    <select id="selectListByEids" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select
        id, electricity_cabinet_id, cell_no, sn, usable_status,
        status,is_lock,is_fan,temperature,is_heat,is_light,
        temperature,battery_type,power,charge_v,b_id
        from t_electricity_cabinet_box
        where
        del_flag = 0
        and electricity_cabinet_id in
        <foreach collection="eIdList" separator="," open="(" close=")" item="id">
            #{id}
        </foreach>
    </select>

    <update id="modifyCellUsableStatus">
        update t_electricity_cabinet_box
        set usable_status=1
        where electricity_cabinet_id = #{electricityCabinetId}
          and cell_no = #{cellNo}
          and del_flag = 0
    </update>

    <select id="queryBoxCount" resultType="integer">
        select count(1) from t_electricity_cabinet_box
        where del_flag=0
        <if test="id != null">
            and electricity_cabinet_id = #{id}
        </if>
        <if test="tenantId != null ">
            and tenant_id = #{tenantId}
        </if>
    </select>

    <select id="selectEleBoxAttrByEid" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select
            id, electricity_cabinet_id, cell_no, sn, usable_status,
            status,is_lock,is_fan,temperature,is_heat,is_light,
            temperature,battery_type,power,charge_v,b_id
        from t_electricity_cabinet_box
        where
        electricity_cabinet_id = #{eid}
        and usable_status = 0
        and del_flag = 0
    </select>
    
    <select id="selectListByElectricityCabinetIdS" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select id, electricity_cabinet_id, cell_no, sn, usable_status, status,is_lock,is_fan,is_heat,is_light, create_time, update_time,
        del_flag,tenant_id,temperature,battery_type,charge_v,charge_a,version,lock_type,empty_grid_start_time
        from t_electricity_cabinet_box
        <where>
            tenant_id = #{tenantId}
            <if test="electricityCabinetIdS != null and electricityCabinetIdS.size() > 0">
                and electricity_cabinet_id in
                <foreach collection="electricityCabinetIdS" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>
    
    <select id="selectEleBoxByBatteryId" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        SELECT
            id, electricity_cabinet_id, cell_no, sn, usable_status, status,is_lock,is_fan,is_heat,is_light, create_time, update_time,
            del_flag,tenant_id,temperature,battery_type,charge_v,charge_a,version,lock_type,empty_grid_start_time
        FROM t_electricity_cabinet_box
        WHERE b_id = #{batteryId}
          AND del_flag = 0
        ORDER BY update_time LIMIT 1
    </select>
    
    <!--新增所有列-->
    <insert id="batchInsertEleBox">
        insert into t_electricity_cabinet_box (electricity_cabinet_id, cell_no, create_time, update_time, del_flag, tenant_id) values
        <foreach item="item" index="index" collection="boxList" separator=",">
            (#{item.electricityCabinetId}, #{item.cellNo}, #{item.createTime}, #{item.updateTime}, #{item.delFlag}, #{item.tenantId})
        </foreach>
    </insert>
    
    
    <select id="selectHaveBatteryCellId" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select id,
               electricity_cabinet_id,
               cell_no,
               sn,
               usable_status,
               status,
               is_lock,
               is_fan,
               temperature,
               is_heat,
               is_light,
               temperature,
               battery_type,
               power,
               charge_v,
               b_id
        from t_electricity_cabinet_box
        where electricity_cabinet_id = #{eid}
          and usable_status = 0
          and status = 0
          and del_flag = 0
    </select>
    
    <sql id="column">
        id, electricity_cabinet_id, cell_no, sn, usable_status,
        status,is_lock,is_fan,temperature,is_heat,is_light, create_time,
        update_time,
        del_flag,tenant_id,temperature,battery_type,charge_v,charge_a,version,lock_type,empty_grid_start_time
    </sql>
    
    <select id="selectListBySnList" resultType="com.xiliulou.electricity.entity.ElectricityCabinetBox">
        select
        <include refid="column"/>
        from t_electricity_cabinet_box
        <where>
            sn in
            <foreach collection="snList" item="sn" separator="," open="(" close=")">
                #{sn}
            </foreach>
            and del_flag = 0
        </where>
    </select>
</mapper>
