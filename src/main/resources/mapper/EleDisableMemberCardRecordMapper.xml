<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiliulou.electricity.mapper.EleDisableMemberCardRecordMapper">


    <select id="queryList" resultType="com.xiliulou.electricity.vo.EleDisableMemberCardRecordVO">
        select
        dmcr.member_card_name,
        dmcr.status,
        dmcr.user_name,
        dmcr.phone,
        dmcr.create_time,
        dmcr.update_time,
        dmcr.tenant_id,
        dmcr.err_msg,
        dmcr.battery_member_card_id,
        dmcr.disable_member_card_no,
        dmcr.card_days,
        dmcr.choose_days ,
        dmcr.real_days ,
        dmcr.pay_status,
        dmcr.charge_rate,
        dmcr.disable_card_time_type ,
        dmcr.apply_reason,
        emcr.disable_time,
        emcr.enable_time
        from  t_ele_disable_member_card_record  dmcr left join t_enable_member_card_record emcr on dmcr.disable_member_card_no=emcr.disable_member_card_no
        <where>
            <if test="query.tenantId !=null">
                and dmcr.tenant_id=#{query.tenantId}
            </if>
            <if test="query.uid !=null">
                and dmcr.uid=#{query.uid}
            </if>
            <if test="query.disableMemberCardNo !=null and query.disableMemberCardNo != '' ">
                and dmcr.disable_member_card_no=#{query.disableMemberCardNo}
            </if>
            <if test="query.phone !=null and query.phone != '' ">
                and dmcr.phone=#{query.phone}
            </if>
            <if test="query.status !=null ">
                and dmcr.status=#{query.status}
            </if>
            <if test="query.franchiseeIds != null">
                and dmcr.franchisee_id in
                <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")"  separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="query.storeIds != null">
                and dmcr.store_id in
                <foreach collection="query.storeIds" item="id" index="index" open="(" close=")"  separator=",">
                    #{id}
                </foreach>
            </if>
        </where>
        order by dmcr.create_time desc
        limit #{query.offset},#{query.size}
    </select>


    <select id="queryCount" resultType="integer">
        select count(1) from t_ele_disable_member_card_record
        <where>
            <if test="query.tenantId != null">
                and tenant_id=#{query.tenantId}
            </if>
            <if test="query.disableMemberCardNo !=null and query.disableMemberCardNo != '' ">
                and disable_member_card_no=#{query.disableMemberCardNo}
            </if>
            <if test="query.phone !=null and query.phone != '' ">
                and phone=#{query.phone}
            </if>
            <if test="query.status !=null ">
                and status=#{query.status}
            </if>
            <if test="query.franchiseeIds != null">
                and franchisee_id in
                <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")"  separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="query.storeIds != null">
                and store_id in
                <foreach collection="query.storeIds" item="id" index="index" open="(" close=")"  separator=",">
                    #{id}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryCreateTimeMaxEleDisableMemberCardRecord"
            resultType="com.xiliulou.electricity.entity.EleDisableMemberCardRecord">
        select id,member_card_name, status, user_name,phone, create_time, update_time,tenant_id, err_msg,
        disable_member_card_no,card_days,choose_days , real_days , pay_status,charge_rate,disable_card_time_type from
        t_ele_disable_member_card_record
        where uid=#{uid} and tenant_id=#{tenantId} order by create_time desc limit 1
    </select>

    <select id="queryDisableCardExpireRecord" resultType="com.xiliulou.electricity.entity.EleDisableMemberCardRecord">
        select id,uid,tenant_id,disable_member_card_no,choose_days,user_name,phone,update_time,charge_rate from t_ele_disable_member_card_record
        where status=1 and disable_card_time_type=1 and real_days is null and disable_deadline &lt;=#{nowTime}
        limit #{offset},#{size};
    </select>
    
    <select id="queryByDisableMemberCardNo" resultType="com.xiliulou.electricity.entity.EleDisableMemberCardRecord">
        select id,member_card_name,status,user_name,phone,create_time,update_time,tenant_id,err_msg,disable_member_card_no,uid
        card_days,choose_days,real_days,pay_status,charge_rate,disable_card_time_type,disable_deadline,battery_member_card_id
        from t_ele_disable_member_card_record
        where disable_member_card_no = #{disableMemberCardNo} and tenant_id = #{tenantId}
    </select>
</mapper>
