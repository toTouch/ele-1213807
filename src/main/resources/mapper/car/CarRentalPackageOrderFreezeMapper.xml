<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiliulou.electricity.mapper.car.CarRentalPackageOrderFreezeMapper">

    <resultMap type="com.xiliulou.electricity.entity.car.CarRentalPackageOrderFreezePo" id="entityMap">
        <!--基础映射 -->
        <result property="id" column="id" jdbcType="BIGINT" />
        <result property="tenantId" column="tenant_id" jdbcType="INTEGER" />
        <result property="franchiseeId" column="franchisee_id" jdbcType="INTEGER" />
        <result property="storeId" column="store_id" jdbcType="INTEGER" />
        <result property="createUid" column="create_uid" jdbcType="BIGINT" />
        <result property="updateUid" column="update_uid" jdbcType="BIGINT" />
        <result property="createTime" column="create_time" jdbcType="BIGINT" />
        <result property="updateTime" column="update_time" jdbcType="BIGINT" />
        <result property="delFlag" column="del_flag" jdbcType="INTEGER" />
        <!-- 私有映射 -->
        <result property="uid" column="uid" jdbcType="BIGINT" />
        <result property="orderNo" column="order_no" jdbcType="VARCHAR" />
        <result property="rentalPackageOrderNo" column="rental_package_order_no" jdbcType="VARCHAR" />
        <result property="rentalPackageId" column="rental_package_id" jdbcType="BIGINT" />
        <result property="rentalPackageType" column="rental_package_type" jdbcType="INTEGER" />
        <result property="residue" column="residue" jdbcType="BIGINT" />
        <result property="residueUnit" column="residue_unit" jdbcType="INTEGER" />
        <result property="lateFee" column="late_fee" jdbcType="DECIMAL" />
        <result property="applyTerm" column="apply_term" jdbcType="INTEGER" />
        <result property="applyTime" column="apply_time" jdbcType="BIGINT" />
        <result property="auditTime" column="audit_time" jdbcType="BIGINT" />
        <result property="auditorId" column="auditor_id" jdbcType="BIGINT" />
        <result property="enableTime" column="enable_time" jdbcType="BIGINT" />
        <result property="status" column="status" jdbcType="INTEGER" />
        <result property="remark" column="remark" jdbcType="VARCHAR" />
        <result property="applyReason" column="apply_reason" jdbcType="VARCHAR" />
    </resultMap>

    <!-- 表名 -->
    <sql id="table_name">`t_car_rental_package_order_freeze`</sql>

    <!-- 基础字段 -->
    <sql id="basic_field">
        `id`, `tenant_id`, `franchisee_id`, `store_id`, `create_uid`, `update_uid`, `create_time`, `update_time`, `del_flag`,
    </sql>

    <!-- 私有字段 -->
    <sql id="private_field">
        `uid`, `order_no`, `rental_package_order_no`, `rental_package_id`, `rental_package_type`, `residue`, `residue_unit`, `late_fee`, `apply_term`, `apply_time`,
        `audit_time`, `enable_time`, `status`, `remark`, `apply_reason`, `auditor_id`
    </sql>

    <!-- 全部字段 -->
    <sql id="all_field">
        <include refid="basic_field" />
        <include refid="private_field" />
    </sql>

    <!-- where 查询条件 -->
    <sql id="where_field">
        <if test=" tenantId != null "> AND `tenant_id` = #{tenantId} </if>
        <if test=" franchiseeId != null "> AND `franchisee_id` = #{franchiseeId} </if>
        <if test=" storeId != null "> AND `store_id` = #{storeId} </if>
        <if test=" orderNo != null and orderNo != '' "> AND `order_no` = #{orderNo} </if>
        <if test=" uid != null "> AND `uid` = #{uid} </if>
        <if test=" status != null "> AND `status` = #{status} </if>
        <if test=" createTimeBegin != null and createTimeEnd != null "> AND `create_time` BETWEEN #{createTimeBegin} AND #{createTimeEnd} </if>
        <if test=" franchiseeIdList != null and franchiseeIdList.size > 0 ">
            AND `franchisee_id` IN
            <foreach collection="franchiseeIdList" item="franchiseeId" open="(" close=")" separator=",">
                #{franchiseeId}
            </foreach>
        </if>
        <if test=" storeIdList != null and storeIdList.size > 0 ">
            AND `store_id` IN
            <foreach collection="storeIdList" item="storeId" open="(" close=")" separator=",">
                #{storeId}
            </foreach>
        </if>
    </sql>

    <!-- 条件新增字段 -->
    <sql id="insert_field">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test=" tenantId != null "> `tenant_id`, </if>
            <if test=" franchiseeId != null "> `franchisee_id`, </if>
            <if test=" storeId != null "> `store_id`, </if>
            <if test=" createUid != null "> `create_uid`, </if>
            <if test=" updateUid != null "> `update_uid`, </if>
            <if test=" createTime != null "> `create_time`, </if>
            <if test=" updateTime != null "> `update_time`, </if>
            <if test=" delFlag != null "> `del_flag`, </if>
            <if test=" uid != null "> `uid`, </if>
            <if test=" orderNo != null and orderNo != '' "> `order_no`, </if>
            <if test=" rentalPackageOrderNo != null and rentalPackageOrderNo != '' "> `rental_package_order_no`, </if>
            <if test=" rentalPackageId != null "> `rental_package_id`, </if>
            <if test=" rentalPackageType != null "> `rental_package_type`, </if>
            <if test=" residue != null "> `residue`, </if>
            <if test=" residueUnit != null "> `residue_unit`, </if>
            <if test=" lateFee != null "> `late_fee`, </if>
            <if test=" applyTerm != null "> `apply_term`, </if>
            <if test=" applyTime != null "> `apply_time`, </if>
            <if test=" auditTime != null "> `audit_time`, </if>
            <if test=" auditorId != null "> `auditor_id`, </if>
            <if test=" enableTime != null "> `enable_time`, </if>
            <if test=" status != null "> `status`, </if>
            <if test=" remark != null and remark != '' "> `remark`, </if>
            <if test=" applyReason != null and applyReason != '' "> `apply_reason`, </if>
        </trim>
    </sql>
    <!-- 条件新增字段值 -->
    <sql id="insert_value">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test=" tenantId != null "> #{tenantId}, </if>
            <if test=" franchiseeId != null "> #{franchiseeId}, </if>
            <if test=" storeId != null "> #{storeId}, </if>
            <if test=" createUid != null "> #{createUid}, </if>
            <if test=" updateUid != null "> #{updateUid}, </if>
            <if test=" createTime != null "> #{createTime}, </if>
            <if test=" updateTime != null "> #{updateTime}, </if>
            <if test=" delFlag != null "> #{delFlag}, </if>
            <if test=" uid != null "> #{uid}, </if>
            <if test=" orderNo != null and orderNo != '' "> #{orderNo}, </if>
            <if test=" rentalPackageOrderNo != null and rentalPackageOrderNo != '' "> #{rentalPackageOrderNo}, </if>
            <if test=" rentalPackageId != null "> #{rentalPackageId}, </if>
            <if test=" rentalPackageType != null "> #{rentalPackageType}, </if>
            <if test=" residue != null "> #{residue}, </if>
            <if test=" residueUnit != null "> #{residueUnit}, </if>
            <if test=" lateFee != null "> #{lateFee}, </if>
            <if test=" applyTerm != null "> #{applyTerm}, </if>
            <if test=" applyTime != null "> #{applyTime}, </if>
            <if test=" auditTime != null "> #{auditTime}, </if>
            <if test=" auditorId != null "> #{auditorId}, </if>
            <if test=" enableTime != null "> #{enableTime}, </if>
            <if test=" status != null "> #{status}, </if>
            <if test=" remark != null and remark != '' "> #{remark}, </if>
            <if test=" applyReason != null and applyReason != '' "> #{applyReason}, </if>
        </trim>
    </sql>

    <!-- 根据用户UID查询最后一笔冻结订单 -->
    <select id="selectLastFreeByUid" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `uid` = #{uid} AND `del_flag` = 0
        </where>
        ORDER BY `id` DESC LIMIT 1
    </select>

    <!-- 根据用户ID查询冻结中的订单 -->
    <select id="selectFreezeByUid" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `uid` = #{uid} AND `status` = 2 AND `del_flag` = 0
        </where>
    </select>

    <!-- 根据订单编码进行数据更新 -->
    <update id="updateByOrderNo">
        UPDATE <include refid="table_name" />
        <set>
            `update_time` = #{updateTime}
            <if test=" auditTime != null "> , `audit_time` = #{auditTime} </if>
            <if test=" auditorId != null "> , `auditor_id` = #{auditorId} </if>
            <if test=" enableTime != null "> , `enable_time` = #{enableTime} </if>
            <if test=" status != null "> , `status` = #{status} </if>
            <if test=" remark != null and remark != '' "> , `remark` = #{remark} </if>
            <if test=" updateUid != null "> , `update_uid` = #{updateUid} </if>
        </set>
        <where>
            `order_no` = #{orderNo}
        </where>
    </update>

    <!-- 根据用户ID和购买订单编号启用冻结订单 -->
    <update id="enableByUidAndPackageOrderNo">
        UPDATE <include refid="table_name" />
        <set>
            `status` = #{status}, `update_time` = #{optTime}, `enable_time` = #{enableTime}
            <if test=" optUid != null "> , `update_uid` = #{optUid} </if>
        </set>
        <where>
            `uid` = #{uid} AND `rental_package_order_no` = #{packageOrderNo} AND `status` = 2 AND `del_flag` = 0
        </where>
    </update>

    <!-- 根据用户ID和套餐购买订单编号查询冻结中的订单 -->
    <select id="selectFreezeByUidAndPackageOrderNo" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `uid` = #{uid} AND `rental_package_order_no` = #{packageOrderNo} AND `status` = 2 AND `del_flag` = 0
        </where>
    </select>

    <!-- 根据冻结申请单编号，撤销冻结申请 -->
    <update id="revokeByOrderNo">
        UPDATE <include refid="table_name" />
        <set>
            `status` = 6, `update_time` = #{optTime}, `update_uid` = #{optUid}
        </set>
        <where>
            `order_no` = #{orderNo}
        </where>
    </update>

    <!-- 根据用户查询待审核的冻结订单 -->
    <select id="selectPendingApprovalByUid" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `tenant_id` = #{tenantId} AND `uid` = #{uid} AND `status` = 1 AND `del_flag` = 0
        </where>
    </select>

    <!-- 条件查询列表 -->
    <select id="list" parameterType="com.xiliulou.electricity.model.car.query.CarRentalPackageOrderFreezeQryModel" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `del_flag` = 0
            <include refid="where_field" />
        </where>
    </select>

    <!-- 条件查询分页 -->
    <select id="page" parameterType="com.xiliulou.electricity.model.car.query.CarRentalPackageOrderFreezeQryModel" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `del_flag` = 0
            <include refid="where_field" />
        </where>
        ORDER BY `create_time` DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 条件查询总数 -->
    <select id="count" parameterType="com.xiliulou.electricity.model.car.query.CarRentalPackageOrderFreezeQryModel" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM <include refid="table_name" />
        <where>
            `del_flag` = 0
            <include refid="where_field" />
        </where>
    </select>

    <!-- 根据订单编码查询 -->
    <select id="selectByOrderNo" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `order_no` = #{orderNo}
        </where>
    </select>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `id` = #{id}
        </where>
    </select>

    <!-- 条件新增 -->
    <insert id="insert" parameterType="com.xiliulou.electricity.entity.car.CarRentalPackageOrderFreezePo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO <include refid="table_name" /> <include refid="insert_field" /> VALUES <include refid="insert_value" />
    </insert>

    <select id="selectLatestFreezeOrder" resultMap="entityMap">
        SELECT <include refid="all_field" /> FROM <include refid="table_name" />
        <where>
            `rental_package_order_no` = #{purchaseOrderNo}
        </where>
        ORDER BY id DESC limit 1
    </select>

</mapper>
