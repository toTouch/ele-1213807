<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiliulou.electricity.mapper.FranchiseeUserInfoMapper">

    <!-- 基础字段 -->
    <sql id="selectFranchiseeUserInfo">
        select id, user_info_id, service_status, franchisee_id, card_id, card_name, card_type, member_card_expire_time, remaining_number, init_electricity_battery_sn, battery_deposit, order_id, del_flag, create_time, update_time, tenant_id, model_type, battery_type, battery_service_fee_generate_time, battery_service_fee_status, member_card_disable_status, disable_member_card_time, rent_car_status, rent_car_order_id, rent_car_deposit, bind_car_id, bind_car_model_id, rent_car_card_id, rent_car_member_card_expire_time
        from t_franchisee_user_info
    </sql>

    <select id="selectByNowBattery" resultType="com.xiliulou.electricity.entity.FranchiseeUserInfo">
        <include refid="selectFranchiseeUserInfo"/>
        where del_flag = 0
        <if test="batteryName != null and batteryName !=''">
            and now_electricity_battery_sn =#{batteryName}
        </if>
        limit 1
    </select>

    <update id="unBind">
        update t_franchisee_user_info
        set service_status = #{serviceStatus},
        now_electricity_battery_sn = #{nowElectricityBatterySn},
        <if test="initElectricityBatterySn != null">
            init_electricity_battery_sn = #{initElectricityBatterySn},
        </if>
        update_time = #{updateTime}
        where id = #{id} and del_flag=0
    </update>


    <update id="updateRefund">
		update t_franchisee_user_info
        set service_status = #{serviceStatus},
            order_id = #{orderId},
            battery_deposit = #{batteryDeposit},
            update_time = #{updateTime}
        where id = #{id} and del_flag=0
	</update>

    <!--    <update id="updateByUserInfoId">
            update t_franchisee_user_info
            set now_electricity_battery_sn = #{nowElectricityBatterySn},
            <if test="serviceStatus != null">
                service_status = #{serviceStatus},
            </if>
            <if test="initElectricityBatterySn != null">
                init_electricity_battery_sn = #{initElectricityBatterySn},
            </if>
            <if test="batteryServiceFeeStatus != null">
                battery_service_fee_status = #{batteryServiceFeeStatus},
            </if>
            update_time = #{updateTime}
            where user_info_id = #{userInfoId} and del_flag=0
        </update>-->
    <update id="updateByUserInfoId">
        update t_franchisee_user_info
        set
        <if test="serviceStatus != null">
            service_status = #{serviceStatus},
        </if>
        <if test="initElectricityBatterySn != null">
            init_electricity_battery_sn = #{initElectricityBatterySn},
        </if>
        <if test="batteryServiceFeeStatus != null">
            battery_service_fee_status = #{batteryServiceFeeStatus},
        </if>
        <if test="tenantId != null">
            tenant_id = #{tenantId},
        </if>
        update_time = #{updateTime}
        where user_info_id = #{userInfoId}
    </update>

    <update id="updateByOrder">
		update t_franchisee_user_info
		set service_status = #{serviceStatus},
		update_time = #{updateTime},
		battery_deposit = #{batteryDeposit},
		order_id = #{orderId},
		franchisee_id = #{franchiseeId},
		model_type = #{modelType},
		battery_type = #{batteryType},
		card_id = #{cardId},
		card_name = #{cardName},
		card_type = #{cardType},
		member_card_expire_time = #{memberCardExpireTime},
		remaining_number = #{remainingNumber}
		where id = #{id} and del_flag=0
	</update>


    <update id="updateOrderByUserInfoId">
		update t_franchisee_user_info
		set service_status = #{serviceStatus},
		update_time = #{updateTime},
		battery_deposit = #{batteryDeposit},
		order_id = #{orderId},
		franchisee_id = #{franchiseeId},
		model_type = #{modelType},
		battery_type = #{batteryType},
		card_id = #{cardId},
		card_name = #{cardName},
		card_type = #{cardType},
		member_card_expire_time = #{memberCardExpireTime},
		remaining_number = #{remainingNumber}
		where user_info_id = #{userInfoId} and del_flag=0
	</update>


    <select id="queryFranchiseeUserInfoByUid" resultType="com.xiliulou.electricity.entity.FranchiseeUserInfo">
        select tf.id ,tf.user_info_id,tf.service_status,tf.franchisee_id,tf.card_id,tf.card_name,tf.card_type,tf.member_card_expire_time,
                tf.remaining_number,tf.init_electricity_battery_sn,tf.battery_deposit,tf.order_id,tf.del_flag,
                tf.create_time,tf.update_time,tf.tenant_id,tf.model_type,tf.battery_type,tf.battery_service_fee_status,tf.battery_service_fee_generate_time,
                tf.rent_car_status,tf.rent_car_order_id,tf.rent_car_deposit,tf.bind_car_id,tf.bind_car_model_id,tf.rent_car_card_id,tf.member_card_disable_status,tf.rent_car_member_card_expire_time,
                tf.disable_member_card_time
                from t_franchisee_user_info tf
                left join t_user_info tu on tf.user_info_id=tu.id where tu.uid=#{uid} and tf.del_flag=0
    </select>


    <update id="updateRentCar">
        update t_franchisee_user_info
        set rent_car_status = #{rentCarStatus},
            bind_car_id=#{bindCarId},
            update_time = #{updateTime}
        where id = #{id} and del_flag=0
    </update>

    <update id="modifyRentCarStatus">
         update t_franchisee_user_info
        set rent_car_status = #{rentCarStatus},
            bind_car_id=#{bindCarId},
            update_time = #{updateTime},
            rent_car_order_id=#{rentCarOrderId},
            bind_car_model_id=#{bindCarModelId},
            rent_car_deposit=#{rentCarDeposit},
            rent_car_card_id=#{rentCarCardId},
            rent_car_member_card_expire_time=#{rentCarMemberCardExpireTime}
        where id = #{id} and del_flag=0
    </update>


    <update id="modifyRentCarStatusByUserInfoId">
          update t_franchisee_user_info
        set rent_car_status = #{rentCarStatus},
            bind_car_id=#{bindCarId},
            update_time = #{updateTime},
            rent_car_order_id=#{rentCarOrderId},
            bind_car_model_id=#{bindCarModelId},
            rent_car_deposit=#{rentCarDeposit},
            rent_car_card_id=#{rentCarCardId},
            rent_car_member_card_expire_time=#{rentCarMemberCardExpireTime}
        where user_info_id = #{userInfoId} and del_flag=0
    </update>

    <update id="updateMemberCardExpire">
        update t_franchisee_user_info
        <set>
            <if test="memberCardExpireTime != null">
                member_card_expire_time = #{memberCardExpireTime},
            </if>
            <if test="remainingNumber != null">
                remaining_number = #{remainingNumber},
            </if>
            <if test="cardId != null">
                card_id = #{cardId},
            </if>
            <if test="cardName != null and cardName !=''">
                card_name = #{cardName},
            </if>
            <if test="cardType != null">
                card_type = #{cardType},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="batteryServiceFeeGenerateTime != null">
                battery_service_fee_generate_time = #{batteryServiceFeeGenerateTime},
            </if>
            <if test="memberCardDisableStatus != null">
                member_card_disable_status = #{memberCardDisableStatus},
            </if>
        </set>
        where id = #{id} and del_flag=0
    </update>

    <select id="queryMemberCardExpiringSoon" resultType="com.xiliulou.electricity.query.MemberCardExpiringSoonQuery">
        select  fui.id, fui.card_name, fui.member_card_expire_time, ui.uid, fui.tenant_id
                from t_franchisee_user_info fui
                left join t_user_info ui on fui.user_info_id = ui.id
                where fui.del_flag = 0 and fui.member_card_expire_time &gt;= #{startExpireTime} and fui.member_card_expire_time &lt;= #{endExpireTime}
                limit #{offset}, #{size}
    </select>


    <update id="unBindNowBatterySn">
        update t_franchisee_user_info
        set now_electricity_battery_sn = #{nowElectricityBatterySn},
        update_time = #{updateTime}
        where id = #{id}
    </update>

    <select id="batteryMemberCardExpire" resultType="com.xiliulou.electricity.query.BatteryMemberCardExpiringSoonQuery">
        select  fui.id, fui.card_name, fui.member_card_expire_time, ui.uid, fui.tenant_id, uob.third_id
                from t_franchisee_user_info fui
                left join t_user_info ui on fui.user_info_id = ui.id
                left join t_user_oauth_bind uob on uob.uid = ui.uid
                where fui.del_flag = 0
                and fui.member_card_expire_time &gt; #{firstTime}
                and fui.member_card_expire_time &lt;= #{lastTime}
                limit #{offset}, #{size}
    </select>

    <select id="carMemberCardExpire" resultType="com.xiliulou.electricity.query.CarMemberCardExpiringSoonQuery">
        select  fui.id, emc.name as card_name, fui.rent_car_member_card_expire_time, ui.uid, fui.tenant_id, uob.third_id
                from t_franchisee_user_info fui
                left join t_user_info ui on fui.user_info_id = ui.id
                left join t_user_oauth_bind uob on uob.uid = ui.uid
                left join t_electricity_member_card emc on fui.rent_car_card_id = emc.id
                where fui.del_flag = 0
                and fui.rent_car_member_card_expire_time &gt; #{firstTime}
                and fui.rent_car_member_card_expire_time &lt;= #{lastTime}
                limit #{offset}, #{size}
    </select>

    <update id="updatePayServiceFeeById">
        update t_franchisee_user_info
        set
        <if test="serviceStatus != null">
            service_status = #{serviceStatus},
        </if>
        <if test="initElectricityBatterySn != null">
            init_electricity_battery_sn = #{initElectricityBatterySn},
        </if>
        <if test="batteryServiceFeeStatus != null">
            battery_service_fee_status = #{batteryServiceFeeStatus},
        </if>
        <if test="tenantId != null">
            tenant_id = #{tenantId},
        </if>
        <if test="cardId != null">
            card_id = #{cardId},
        </if>
        <if test="cardName != null and cardName !=''">
            card_name = #{cardName},
        </if>
        <if test="memberCardExpireTime != null">
            member_card_expire_time = #{memberCardExpireTime},
        </if>
        <if test="remainingNumber != null">
            remaining_number = #{remainingNumber},
        </if>
        <if test="cardType != null">
            card_type = #{cardType},
        </if>
        <if test="batteryServiceFeeGenerateTime != null">
            battery_service_fee_generate_time = #{batteryServiceFeeGenerateTime},
        </if>
        <if test="memberCardDisableStatus != null">
            member_card_disable_status = #{memberCardDisableStatus},
        </if>
        <if test="batteryDeposit != null">
            battery_deposit = #{batteryDeposit},
        </if>
        <if test="orderId != null">
            order_id = #{orderId},
        </if>
        <if test="delFlag != null">
            del_flag = #{delFlag},
        </if>
        <if test="modelType != null">
            model_type = #{modelType},
        </if>
        <if test="batteryType != null and batteryType !=''">
            battery_type = #{batteryType},
        </if>
        <if test="disableMemberCardTime != null">
            disable_member_card_time = #{disableMemberCardTime},
        </if>
        <if test="rentCarStatus != null">
            rent_car_status = #{rentCarStatus},
        </if>
        <if test="rentCarStatus != null">
            rent_car_status = #{rentCarStatus},
        </if>
        <if test="rentCarOrderId != null and rentCarOrderId !=''">
            rent_car_order_id = #{rentCarOrderId},
        </if>
        <if test="rentCarDeposit != null">
            rent_car_deposit = #{rentCarDeposit},
        </if>
        <if test="bindCarId != null">
            bind_car_id = #{bindCarId},
        </if>
        <if test="bindCarModelId != null">
            bind_car_model_id = #{bindCarModelId},
        </if>
        <if test="rentCarCardId != null">
            rent_car_card_id = #{rentCarCardId},
        </if>
        <if test="rentCarMemberCardExpireTime != null">
            rent_car_member_card_expire_time = #{rentCarMemberCardExpireTime},
        </if>
        update_time = #{updateTime}
        where id = #{id}
    </update>
</mapper>
