<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiliulou.electricity.mapper.ElectricityBatteryMapper">
    
    <!-- 基础字段 -->
    <sql id="selectElectricityBattery">
        select id,
               sn,
               longitude,
               latitude,
               power,
               voltage,
               capacity,
               model,
               status,
               electricity_cabinet_id,
               electricity_cabinet_name,
               uid,
               create_time,
               update_time,
               charge_status,
               health_status,
               tenant_id,
               borrow_expire_time,
               iot_card_number,
               exchange_count,
               franchisee_id,
               business_status,
               physics_status,
               stock_status
        from t_electricity_battery
    </sql>
    
    <delete id="batchDeleteBySnList">
        DELETE FROM `t_electricity_battery`
        WHERE `tenant_id` = #{tenantId} AND `sn` IN
        <foreach collection="batterySnList" item="batterySn" open="(" close=")" separator=",">
            #{batterySn}
        </foreach>
    </delete>
    
    <select id="selectListBySnList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        SELECT `id`, `sn`, `uid`, `tenant_id`, `franchisee_id` FROM `t_electricity_battery`
        <where>
            del_flag = 0
            <if test=" tenantId != null "> AND `tenant_id` = #{tenantId} </if>
            <if test=" batterySns != null and batterySns.size > 0 ">
                AND `sn` IN
                <foreach collection="batterySns" item="batterySn" open="(" close=")" separator=",">
                    #{batterySn}
                </foreach>
            </if>
            
            <if test="franchiseeIdList != null and franchiseeIdList.size() > 0">
                AND franchisee_id IN
                <foreach collection="franchiseeIdList" item="franchiseeId" open="(" close=")" separator=",">
                    #{franchiseeId}
                </foreach>
            </if>
        </where>
    </select>
    
    <select id="selectListByUid" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        SELECT `id`, `sn`, `uid`, `tenant_id`, `franchisee_id` FROM `t_electricity_battery`
        <where>
            del_flag = 0
            <if test=" uid != null "> AND `uid` = #{uid} </if>
            <if test=" tenantId != null "> AND `tenant_id` = #{tenantId} </if>
        </where>
    </select>
    
    <!--查询单个-->
    <select id="selectById" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        <include refid="selectElectricityBattery"/>
        where id = #{id} and tenant_id = #{tenantId}
    </select>
    
    <select id="isFranchiseeBindBattery" resultType="Integer">
        SELECT 1
        FROM t_electricity_battery
        WHERE del_flag = 0
          and franchisee_id = #{franchiseeId}
          AND tenant_id = #{tenantId} LIMIT 1
    </select>
    
    <select id="isUserBindBattery" resultType="Integer">
        SELECT 1
        FROM t_electricity_battery
        WHERE del_flag = 0
          and uid = #{uid}
          AND tenant_id = #{tenantId} LIMIT 1
    </select>
    
    
    <!--电池分页-->
    <!--	<select id="queryList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
            select b.id, b.sn,b.power, b.voltage, b.capacity, b.status , b.business_status, b.create_time, b.update_time, b.del_flag, b.tenant_id, b.electricity_cabinet_id,
            b.model,b.charge_status,b.iot_card_number
            from t_electricity_battery b
            where b.del_flag = 0 and b.tenant_id = #{query.tenantId}
            <if test="query.sn != null and query.sn !=''">
                and b.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
            </if>
            <if test="query.status != null">
                and b.status =#{query.status}
            </if>
            <if test="query.businessStatus != null">
                and b.business_status =#{query.businessStatus}
            </if>
            <if test="query.chargeStatus != null">
                and b.charge_status =#{query.chargeStatus}
            </if>
            <if test="query.tenantId != null">
                and b.tenant_id = #{query.tenantId}
            </if>
            <if test="query.electricityCabinetName != null">
                 and b.electricity_cabinet_name like  concat('%',#{query.electricityCabinetName},'%') and status = 0
             </if>
            <if test="query.electricityBatteryIdList!=null and query.electricityBatteryIdList!=''">
                and b.id in
                <foreach collection="query.electricityBatteryIdList" item="id" index="index" open="(" close=")"
                         separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="query.franchiseeName != null">
                and b.id in (select fbeb.electricity_battery_id from t_franchisee_bind_electricity_battery fbeb left join t_franchisee f on fbeb.franchisee_id = f.id where f.name like concat('%',#{query.franchiseeName},'%'))
            </if>
            order by create_time desc
            limit #{offset}, #{size}
        </select>-->
    <select id="queryList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select teb.id, teb.sn,teb.power, teb.voltage, teb.capacity, teb.physics_status , teb.business_status, teb.create_time, teb.update_time,
               teb.del_flag,teb.tenant_id, teb.electricity_cabinet_id,teb.model, teb.charge_status, teb.iot_card_number, teb.franchisee_id,
               teb.uid,teb.warehouse_id,teb.stock_status,teb.label
        from t_electricity_battery teb
        <if test="query.receiverId != null">
            left join t_electricity_battery_label ebl on teb.sn=ebl.sn
        </if>
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null">
            and teb.business_status =#{query.businessStatus}
        </if>
        <if test="query.stockStatus != null">
            and teb.stock_status =#{query.stockStatus}
        </if>
        <if test="query.warehouseId != null">
            and teb.warehouse_id =#{query.warehouseId}
        </if>
        <if test="query.chargeStatus != null">
            and teb.charge_status =#{query.chargeStatus}
        </if>
        <if test="query.tenantId != null">
            and teb.tenant_id = #{query.tenantId}
        </if>
        <if test="query.power != null">
            and teb.power = #{query.power}
        </if>
        <if test="query.electricityCabinetName != null">
            and teb.electricity_cabinet_name like concat('%',#{query.electricityCabinetName},'%')
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.franchiseeName != null and '' != query.franchiseeName">
            and teb.franchisee_id in (select id from t_franchisee where name like concat('%',#{query.franchiseeName},'%'))
        </if>
        <if test="query.model != null and '' != query.model">
            and teb.model like concat('%',#{query.model},'%')
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        
        <if test="query.bindStatus != null and query.bindStatus == 0">
            and (teb.franchisee_id is null or teb.franchisee_id = 0)
        </if>
        
        <if test="query.bindStatus != null and query.bindStatus == 1">
            and teb.franchisee_id is not null and teb.franchisee_id != 0
        </if>
        <if test="query.label != null">
            and teb.label in
            <foreach collection="query.label" item="label" index="index" open="(" close=")" separator=",">
                #{label}
            </foreach>
        </if>
        <if test="query.receiverId != null">
            and ebl.receiver_id = #{query.receiverId}
        </if>
        order by teb.create_time desc
        limit #{offset}, #{size}
    </select>
    
    <!--电池分页-->
    <!--<select id="queryNotBindList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select b.id, b.sn,b.power, b.voltage, b.capacity, b.status, b.create_time, b.update_time, b.del_flag, b.tenant_id, b.electricity_cabinet_id,
        b.model,b.charge_status
        from t_electricity_battery b
        where b.del_flag = 0 and b.tenant_id = #{tenantId}
        and id not in(
             select electricity_battery_id from t_franchisee_bind_electricity_battery fbeb where 1=1
             <if test="franchiseeId != null">
                 and fbeb.franchisee_id != #{franchiseeId}
             </if>
             )
        order by create_time desc
        limit #{offset}, #{size}
    </select>-->
    <select id="queryNotBindList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id,
               sn,
               power,
               voltage,
               capacity,
               physics_status,
               create_time,
               update_time,
               del_flag,
               tenant_id,
               electricity_cabinet_id,
               model,
               charge_status
        from t_electricity_battery
        where del_flag = 0
          and tenant_id = #{tenantId}
          and (ISNULL(franchisee_id) || (LENGTH(trim(franchisee_id)) = 0) || franchisee_id = 0)
        order by create_time desc
            limit #{offset}, #{size}
    </select>
    
    <select id="queryBindList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id,
               sn,
               power,
               voltage,
               capacity,
               physics_status,
               create_time,
               update_time,
               del_flag,
               tenant_id,
               electricity_cabinet_id,
               model,
               charge_status
        from t_electricity_battery
        where del_flag = 0
          and tenant_id = #{tenantId}
          and franchisee_id = #{franchiseeId}
        order by create_time desc
            limit #{offset}, #{size}
    </select>
    
    <!--	<select id="queryCount" resultType="java.lang.Integer">
            select COUNT(1)
            from t_electricity_battery b
            where b.del_flag = 0
            <if test="query.tenantId != null">
                and b.tenant_id =#{query.tenantId}
            </if>
            <if test="query.sn != null and query.sn !=''">
                and b.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
            </if>
            <if test="query.status != null">
                and b.status =#{query.status}
            </if>
            <if test="query.businessStatus != null">
                and b.business_status =#{query.businessStatus}
            </if>
            <if test="query.chargeStatus != null">
                and b.charge_status =#{query.chargeStatus}
            </if>
            <if test="query.tenantId != null">
                and b.tenant_id = #{query.tenantId}
            </if>
            <if test="query.electricityCabinetName != null">
                and b.electricity_cabinet_name like  concat('%',#{query.electricityCabinetName},'%') and status = 0
            </if>
            <if test="query.electricityBatteryIdList!=null and query.electricityBatteryIdList!=''">
                and b.id in
                <foreach collection="query.electricityBatteryIdList" item="id" index="index" open="(" close=")"
                         separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="query.franchiseeName != null">
                and b.id in (select fbeb.electricity_battery_id from t_franchisee_bind_electricity_battery fbeb left join t_franchisee f on fbeb.franchisee_id = f.id where f.name like concat('%',#{query.franchiseeName},'%'))
            </if>
        </select>-->
    <select id="queryCount" resultType="java.lang.Integer">
        select COUNT(1)
        from t_electricity_battery teb
        <if test="query.receiverId != null">
            left join t_electricity_battery_label ebl on teb.sn=ebl.sn
        </if>
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null">
            and teb.business_status =#{query.businessStatus}
        </if>
        <if test="query.stockStatus != null">
            and teb.stock_status =#{query.stockStatus}
        </if>
        <if test="query.warehouseId != null">
            and teb.warehouse_id =#{query.warehouseId}
        </if>
        <if test="query.chargeStatus != null">
            and teb.charge_status =#{query.chargeStatus}
        </if>
        <if test="query.tenantId != null">
            and teb.tenant_id = #{query.tenantId}
        </if>
        <if test="query.power != null">
            and teb.power = #{query.power}
        </if>
        <if test="query.electricityCabinetName != null">
            and teb.electricity_cabinet_name like concat('%',#{query.electricityCabinetName},'%')
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.franchiseeName != null and '' != query.franchiseeName">
            and teb.franchisee_id in (select id from t_franchisee where name like concat('%',#{query.franchiseeName},'%'))
        </if>
        <if test="query.model != null and '' != query.model">
            and teb.model like concat('%',#{query.model},'%')
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        
        <if test="query.bindStatus != null and query.bindStatus == 0">
            and (teb.franchisee_id is null or teb.franchisee_id = 0)
        </if>
        
        <if test="query.bindStatus != null and query.bindStatus == 1">
            and teb.franchisee_id is not null and teb.franchisee_id != 0
        </if>
        <if test="query.label != null">
            and teb.label in
            <foreach collection="query.label" item="label" index="index" open="(" close=")" separator=",">
                #{label}
            </foreach>
        </if>
        <if test="query.receiverId != null">
            and ebl.receiver_id = #{query.receiverId}
        </if>
    </select>
    
    <select id="selectBatteryInfo" resultType="com.xiliulou.electricity.vo.ElectricityBatteryVO">
        select teb.id                     as id,
               teb.sn                     as sn,
               teb.power                  as power,
               teb.voltage                as voltage,
               teb.longitude,
               teb.latitude,
               teb.capacity               as capacity,
               teb.physics_status         as physicsStatus,
               teb.business_status        as businessStatus,
               teb.create_time            as createTime,
               teb.update_time            as updateTime,
               teb.electricity_cabinet_id as electricityCabinetId,
               tbop.battery_v             as battery_v,
               tbop.battery_charge_a      as battery_charge_a,
               tbop.sum_v                 as sum_v,
               tbop.sum_a                 as sum_a
        FROM t_electricity_battery as teb
                 left join t_battery_other_properties as tbop on teb.sn = tbop.battery_name
        WHERE teb.uid = #{uid}
          and teb.del_flag = 0
    </select>
    
    <select id="selectBatteryDetailInfoBySN" resultType="com.xiliulou.electricity.vo.ElectricityBatteryVO">
        select teb.id                     as id,
               teb.sn                     as sn,
               teb.power                  as power,
               teb.model                  as model,
               teb.voltage                as voltage,
               teb.capacity               as capacity,
               teb.physics_status         as physicsStatus,
               teb.business_status        as businessStatus,
               teb.create_time            as createTime,
               teb.update_time            as updateTime,
               teb.electricity_cabinet_id as electricityCabinetId,
               teb.charge_status          as chargeStatus,
               tbop.battery_v             as batteryV,
               tbop.battery_charge_a      as batteryChargeA,
               tbop.sum_v                 as sum_v,
               tbop.sum_a                 as sum_a,
               tbop.battery_core_temp     as batteryTemperature,
               teb.uid as uid
        FROM t_electricity_battery as teb
                 left join t_battery_other_properties as tbop on teb.sn = tbop.battery_name
        WHERE teb.sn = #{sn}
          and teb.del_flag = 0
    </select>
    <select id="queryBorrowExpireBattery" resultMap="queryBorrowExpireBatteryMap">
        select b.sn, b.electricity_cabinet_name, b.borrow_expire_time, u.name, u.phone, b.physics_status, b.tenant_id
        FROM t_electricity_battery b
                 left join t_user_info u on b.uid = u.uid
        WHERE b.borrow_expire_time &lt; #{curTime}
          and b.del_flag = 0
          and b.physics_status in (2, 3, 4) limit #{offset}
            , #{size}
    </select>
    <resultMap id="queryBorrowExpireBatteryMap" type="com.xiliulou.electricity.vo.BorrowExpireBatteryVo">
        <result column="sn" property="sn"></result>
        <result column="electricity_cabinet_name" property="electricityCabinetName"></result>
        <result column="borrow_expire_time" property="borrowExpireTime"></result>
        <result column="name" property="name"></result>
        <result column="phone" property="phone"></result>
        <result column="status" property="status"></result>
        <result column="tenant_id" property="tenantId"></result>
    </resultMap>
    
    
    <select id="queryLowBattery" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select sn, tenant_id, uid, power
        from t_electricity_battery
        where power &lt; #{batteryLevel}
          and business_status = 2 limit #{offset}
            , #{size}
    </select>
    
    <select id="queryByUid" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id,
               sn,
               power,
               voltage,
               capacity,
               model,
               physics_status,
               business_status,
               create_time,
               update_time,
               bind_time,
               electricity_cabinet_id,
               tenant_id,
               franchisee_id,
               uid
        FROM t_electricity_battery as teb
        WHERE teb.uid = #{uid}
          and teb.del_flag = 0
        order by create_time DESC limit 1
    </select>
    
    <update id="updateBatteryUser">
        update t_electricity_battery
        set
        <if test="chargeStatus != null">
            charge_status =#{chargeStatus},
        </if>
        <if test="healthStatus != null">
            health_status =#{healthStatus},
        </if>
        <if test="power != null">
            power =#{power},
        </if>
        <if test="model != null">
            model =#{model},
        </if>
        <if test="exchangeCount != null">
            exchange_count =#{exchangeCount},
        </if>
        <if test="physicsStatus != null">
            physics_status =#{physicsStatus},
        </if>
        <if test="businessStatus != null">
            business_status=#{businessStatus},
        </if>
        <if test="borrowExpireTime != null">
            borrow_expire_time=#{borrowExpireTime},
        </if>
        <if test="bindTime != null">
            bind_time=#{bindTime},
        </if>
        electricity_cabinet_name=#{electricityCabinetName},
        electricity_cabinet_id=#{electricityCabinetId},
        uid=#{uid},
        update_time=#{updateTime},
        guess_uid=#{guessUid}
        where id=#{id}
    </update>
    
    <select id="selectListBatteryByGuessUid" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id, sn, create_time, update_time, del_flag, uid, guess_uid
        from t_electricity_battery
        where guess_uid = #{guessUid}
          and del_flag = 0
    </select>
    
    <select id="selectListBatteryBySnList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select
        id,
        sn,
        longitude,
        latitude,
        power,
        voltage,
        capacity,
        model,
        status,
        electricity_cabinet_id,
        electricity_cabinet_name,
        uid,
        create_time,
        update_time,
        charge_status,
        health_status,
        tenant_id,
        borrow_expire_time,
        iot_card_number,
        exchange_count,
        franchisee_id,
        business_status,
        physics_status,
        stock_status
        from t_electricity_battery
        where del_flag = 0 and sn in
        <foreach collection="snList" item="sn" open="(" close=")" separator=",">
            #{sn}
        </foreach>
    </select>
    
    <update id="batchUpdateBatteryGuessUid">
        update t_electricity_battery set guess_uid= #{guessUid}
        where id in
        <foreach collection="batteryIdList" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>
    
    <update id="updateBatteryStatus">
        update t_electricity_battery
        set
        <if test="chargeStatus != null">
            charge_status =#{chargeStatus},
        </if>
        <if test="healthStatus != null">
            health_status =#{healthStatus},
        </if>
        <if test="power != null">
            power =#{power},
        </if>
        <if test="model != null">
            model =#{model},
        </if>
        <if test="exchangeCount != null">
            exchange_count =#{exchangeCount},
        </if>
        <if test="physicsStatus != null">
            physics_status =#{physicsStatus},
        </if>
        <if test="businessStatus != null">
            business_status=#{businessStatus},
        </if>
        <if test="borrowExpireTime != null">
            borrow_expire_time=#{borrowExpireTime},
        </if>
        <if test="guessUid != null">
            guess_uid=#{guessUid},
        </if>
        electricity_cabinet_name=#{electricityCabinetName},
        electricity_cabinet_id=#{electricityCabinetId},
        update_time=#{updateTime}
        where id=#{id}
    </update>
    
    <select id="homepageBatteryAnalysis" resultType="com.xiliulou.electricity.vo.HomepageBatteryFrequencyVo">
        select sn,exchange_count as useCount,physics_status from t_electricity_battery b
        where b.del_flag = 0
        <if test="query.tenantId != null">
            and b.tenant_id =#{query.tenantId}
        </if>
        <if test="query.batterySn != null and query.batterySn !=''">
            and b.sn like concat('%',#{query.batterySn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.beginTime != null">
            and b.update_time &gt;=#{query.beginTime}
        </if>
        <if test="query.endTime != null">
            and b.update_time &lt;=#{query.endTime}
        </if>
        <if test="query.franchiseeId != null">
            and b.id in (select fbeb.electricity_battery_id from t_franchisee_bind_electricity_battery fbeb where
            fbeb.franchisee_id=#{query.franchiseeId})
        </if>
        order by exchange_count desc
        limit #{query.offset}, #{query.size}
    </select>
    
    <select id="homepageBatteryAnalysisCount" resultType="com.xiliulou.electricity.vo.HomepageBatteryFrequencyVo">
        select sn,exchange_count as useCount,physics_status from t_electricity_battery b
        where b.del_flag = 0
        <if test="query.tenantId != null">
            and b.tenant_id =#{query.tenantId}
        </if>
        <if test="query.batterySn != null and query.batterySn !=''">
            and b.sn like concat('%',#{query.batterySn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.beginTime != null">
            and b.update_time &gt;=#{query.beginTime}
        </if>
        <if test="query.endTime != null">
            and b.update_time &lt;=#{query.endTime}
        </if>
        <if test="query.franchiseeId != null">
            and b.id in (select fbeb.electricity_battery_id from t_franchisee_bind_electricity_battery fbeb where
            fbeb.franchisee_id=#{query.franchiseeId})
        </if>
    </select>
    
    <!--电池解绑加盟商id-->
    <update id="unbindFranchiseeId">
        update t_electricity_battery
        set tenant_id=#{updateBattery.tenantId},
            franchisee_id=#{updateBattery.franchiseeId},
            update_time=#{updateBattery.updateTime}
        where franchisee_id = #{franchiseeId}
    </update>
    
    
    <!--电池绑定加盟商id-->
    <update id="bindFranchiseeId">
        update t_electricity_battery
        set
        franchisee_id=#{batteryQuery.franchiseeId},
        stock_status = #{stockStatus},
        label = 12
        where id in
        <foreach collection="batteryQuery.electricityBatteryIdList" item="id" index="index" open="(" close=")"
            separator=",">
            #{id}
        </foreach>
    </update>
    
    
    <select id="selectByBatteryIds" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id, sn,power, voltage, capacity, physics_status , business_status, create_time, update_time, del_flag,
        tenant_id, electricity_cabinet_id,
        model, charge_status, iot_card_number, franchisee_id, warehouse_id, label
        from t_electricity_battery
        where del_flag = 0
        and id in
        <foreach collection="batteryIds" item="id" index="index" open="(" close=")"
            separator=",">
            #{id}
        </foreach>
    </select>
    <select id="queryBatteryOverview" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select b.id, b.sn,b.power, b.voltage, b.capacity, b.physics_status , b.business_status, b.create_time,
        b.update_time, b.del_flag, b.tenant_id, b.electricity_cabinet_id,
        b.uid,b.model,b.charge_status,b.iot_card_number,b.longitude,b.latitude
        from t_electricity_battery b
        where b.del_flag = 0 and b.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and b.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.physicsStatus != null">
            and b.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null">
            and b.business_status =#{query.businessStatus}
        </if>
        <if test="query.franchiseeIds != null">
            and b.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        order by create_time desc
    </select>
    
    <select id="batteryStatistical" resultType="com.xiliulou.electricity.vo.BatteryStatisticalVo">
        SELECT COUNT(1) sumCount,
        sum(CASE WHEN status = 0 THEN 1 ELSE 0 END) wareHouseCount ,
        sum(CASE WHEN status = 1 THEN 1 ELSE 0 END) stockCount ,
        sum(CASE WHEN status = 2 THEN 1 ELSE 0 END) leaseCount ,
        sum(CASE WHEN status = 3 THEN 1 ELSE 0 END) exceptionCount ,
        sum(CASE WHEN status = 4 THEN 1 ELSE 0 END) exceptionFreeCount
        FROM t_electricity_battery
        where del_flag=0
        and tenant_id=#{tenantId}
        <if test="franchiseeIds != null">
            and franchisee_id in
            <foreach collection="franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
    </select>
    
    
    <select id="selectBatteryInfoByBatteryName" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id, sn
        from t_electricity_battery
        where del_flag = 0
        <if test="sn != null and sn !=''">
            and sn like concat('%',#{sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="physicsStatus != null">
            and physics_status =#{physicsStatus}
        </if>
        <if test="businessStatus != null">
            and business_status =#{businessStatus}
        </if>
        <if test="tenantId != null">
            and tenant_id = #{tenantId}
        </if>
        limit #{offset}, #{size}
    </select>
    
    <!--通过主键修改数据-->
    <update id="update">
        update t_electricity_battery
        <set>
            <if test="sn != null and sn != ''">
                sn = #{sn},
            </if>
            <if test="longitude != null">
                longitude = #{longitude},
            </if>
            <if test="latitude != null">
                latitude = #{latitude},
            </if>
            <if test="power != null">
                power = #{power},
            </if>
            <if test="voltage != null">
                voltage = #{voltage},
            </if>
            <if test="capacity != null">
                capacity = #{capacity},
            </if>
            <if test="model != null and model != ''">
                model = #{model},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="electricityCabinetId != null">
                electricity_cabinet_id = #{electricityCabinetId},
            </if>
            <if test="electricityCabinetName != null and electricityCabinetName != ''">
                electricity_cabinet_name = #{electricityCabinetName},
            </if>
            <if test="uid != null">
                uid = #{uid},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="delFlag != null">
                del_flag = #{delFlag},
            </if>
            <if test="chargeStatus != null">
                charge_status = #{chargeStatus},
            </if>
            <if test="healthStatus != null">
                health_status = #{healthStatus},
            </if>
            <if test="borrowExpireTime != null">
                borrow_expire_time = #{borrowExpireTime},
            </if>
            <if test="iotCardNumber != null">
                iot_card_number = #{iotCardNumber},
            </if>
            <if test="exchangeCount != null">
                exchange_count = #{exchangeCount},
            </if>
            <if test="franchiseeId != null">
                franchisee_id = #{franchiseeId},
            </if>
            <if test="businessStatus != null">
                business_status = #{businessStatus},
            </if>
            <if test="physicsStatus != null">
                physics_status = #{physicsStatus},
            </if>
            <if test="label != null">
                label = #{label},
            </if>
        </set>
        where id = #{id} and tenant_id = #{tenantId}
    </update>
    
    <!--通过主键删除-->
    <delete id="deleteById">
        delete
        from t_electricity_battery
        where id = #{id}
          and tenant_id = #{tenantId}
    </delete>
    
    <select id="queryPartAttrList" resultType="com.xiliulou.electricity.vo.ElectricityBatteryLocationVO">
        select sn, longitude,latitude
        from t_electricity_battery
        where del_flag=0
        and tenant_id=#{tenantId}
        <if test="franchiseeIds != null">
            and franchisee_id in
            <foreach collection="franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        limit #{offset}, #{size}
    </select>
    
    <insert id="insertBatch" keyProperty="id" useGeneratedKeys="true">
        insert into t_electricity_battery(sn, longitude, latitude, power, voltage, capacity, model, status,
        electricity_cabinet_id, electricity_cabinet_name, uid, create_time, update_time, del_flag,
        charge_status, health_status, tenant_id, borrow_expire_time, iot_card_number, exchange_count, franchisee_id,
        physics_status, business_status,stock_status,warehouse_id,label) values
        <foreach item="c" index="index" collection="list" separator=",">
            (#{c.sn}, #{c.longitude}, #{c.latitude}, #{c.power}, #{c.voltage}, #{c.capacity}, #{c.model}, #{c.status},
            #{c.electricityCabinetId}, #{c.electricityCabinetName}, #{c.uid}, #{c.createTime}, #{c.updateTime},
            #{c.delFlag}, #{c.chargeStatus}, #{c.healthStatus}, #{c.tenantId}, #{c.borrowExpireTime}, #{c.iotCardNumber},
            #{c.exchangeCount}, #{c.franchiseeId}, #{c.physicsStatus}, #{c.businessStatus}, #{c.stockStatus},#{c.warehouseId},#{c.label})
        
        </foreach>
    </insert>
    
    <select id="querySnByUid" resultType="java.lang.String">
        select sn
        FROM t_electricity_battery
        WHERE uid = #{uid}
          and del_flag = 0
    </select>
    
    <select id="queryUserAttrBySn" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select sn, uid, tenant_id
        from t_electricity_battery
        where sn = #{sn}
    </select>
    
    <select id="queryBatteryList" resultType="com.xiliulou.electricity.vo.ElectricityBatteryDataVO">
        select teb.id,teb.sn,teb.longitude,teb.latitude,teb.power,teb.voltage,teb.capacity as
        dbCapacity,teb.model,teb.status,teb.electricity_cabinet_id,teb.electricity_cabinet_name,
        teb.user_name,teb.create_time,teb.update_time,teb.del_flag,teb.charge_status,teb.health_status,teb.tenant_id,teb.borrow_expire_time,
        teb.iot_card_number,teb.exchange_count,teb.uid,teb.guess_uid,teb.franchisee_id,teb.physics_status,teb.business_status,tec.cell_no,teb.label
        from t_electricity_battery teb left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        <if test="query.receiverId != null">
            left join t_electricity_battery_label ebl on teb.sn=ebl.sn
        </if>
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        
        <if test="query.queryType == 2">
            and teb.physics_status =0 and teb.business_status in(2,3,4,5)
        </if>
        <if test="query.queryType == 3">
            and teb.physics_status =0 and teb.business_status=1
        </if>
        <if test="query.queryType == 4">
            and teb.physics_status=1 and teb.business_status in(2,4)
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="query.label != null">
            and teb.label in
            <foreach collection="query.label" item="label" index="index" open="(" close=")" separator=",">
                #{label}
            </foreach>
        </if>
        <if test="query.receiverId != null">
            and ebl.receiver_id = #{query.receiverId}
        </if>
        order by teb.create_time desc
        limit #{offset}, #{size}
    </select>
    <select id="queryBatteryCount" resultType="java.lang.Integer">
        select count(1)
        from t_electricity_battery teb left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        <if test="query.receiverId != null">
            left join t_electricity_battery_label ebl on teb.sn=ebl.sn
        </if>
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        
        <if test="query.queryType == 2">
            and teb.physics_status =0 and teb.business_status in(2,3,4,5)
        </if>
        <if test="query.queryType == 3">
            and teb.physics_status =0 and teb.business_status=1
        </if>
        <if test="query.queryType == 4">
            and teb.physics_status=1 and teb.business_status in(2,4)
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="query.label != null">
            and teb.label in
            <foreach collection="query.label" item="label" index="index" open="(" close=")" separator=",">
                #{label}
            </foreach>
        </if>
        <if test="query.receiverId != null">
            and ebl.receiver_id = #{query.receiverId}
        </if>
    </select>
    
    <update id="updateGuessUidById">
        update t_electricity_battery
        set guess_uid =null
        where id = #{id}
    </update>
    
    <select id="queryStrayBatteryList" resultType="com.xiliulou.electricity.vo.ElectricityBatteryDataVO">
        select teb.id,teb.sn,teb.longitude,teb.latitude,teb.power,teb.voltage,teb.capacity as
        dbCapacity,teb.model,teb.status,teb.electricity_cabinet_id,teb.electricity_cabinet_name,
        teb.user_name,teb.create_time,teb.update_time,teb.del_flag,teb.charge_status,teb.health_status,teb.tenant_id,teb.borrow_expire_time,tbop.battery_v as boxVoltage,
        teb.iot_card_number,teb.exchange_count,teb.uid,teb.franchisee_id,teb.physics_status,teb.business_status,tec.cell_no
        from t_electricity_battery teb left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        and teb.physics_status =1 and teb.business_status in (3,5)
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        
        order by teb.create_time desc
        limit #{offset}, #{size}
    </select>
    <select id="queryStrayBatteryCount" resultType="java.lang.Integer">
        select count(1)
        from t_electricity_battery teb left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        and teb.physics_status =1 and teb.business_status in (3,5)
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </select>
    
    <select id="queryOverdueBatteryList" resultType="com.xiliulou.electricity.vo.ElectricityBatteryDataVO">
        select teb.id,teb.sn,teb.longitude,teb.latitude,teb.power,teb.voltage,teb.capacity as
        dbCapacity,teb.model,teb.status,teb.electricity_cabinet_id,teb.electricity_cabinet_name,
        teb.user_name,teb.create_time,teb.update_time,teb.del_flag,teb.charge_status,teb.health_status,teb.tenant_id,teb.borrow_expire_time,tbop.battery_v as boxVoltage,
        teb.iot_card_number,teb.exchange_count,teb.uid,teb.franchisee_id,teb.physics_status,teb.business_status,tec.cell_no,temc.member_card_expire_time
        from t_electricity_battery teb left join t_user_battery_member_card temc on teb.uid=temc.uid
        left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId} and teb.uid is not null and temc.member_card_expire_time>0 and temc.del_flag=0
        and teb.business_status =2
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.currentTimeMillis != null">
            and temc.member_card_expire_time <![CDATA[ < ]]> #{query.currentTimeMillis}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="query.sort == 0">
            order by temc.member_card_expire_time desc
        </if>
        <if test="query.sort == 1">
            order by temc.member_card_expire_time
        </if>
        limit #{offset}, #{size}
    </select>
    <select id="queryOverdueBatteryCount" resultType="java.lang.Integer">
        select count(1)
        from t_electricity_battery teb left join t_user_battery_member_card temc on teb.uid=temc.uid
        left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId} and teb.uid is not null and temc.member_card_expire_time>0 and temc.del_flag=0
        and teb.business_status =2
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.currentTimeMillis != null">
            and temc.member_card_expire_time <![CDATA[ < ]]> #{query.currentTimeMillis}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
    </select>
    <select id="queryOverdueCarBatteryList" resultType="com.xiliulou.electricity.vo.ElectricityBatteryDataVO">
        select teb.id,teb.sn,teb.longitude,teb.latitude,teb.power,teb.voltage,teb.capacity as
        dbCapacity,teb.model,teb.status,teb.electricity_cabinet_id,teb.electricity_cabinet_name,
        teb.user_name,teb.create_time,teb.update_time,teb.del_flag,teb.charge_status,teb.health_status,teb.tenant_id,teb.borrow_expire_time,tbop.battery_v as boxVoltage,
        teb.iot_card_number,teb.exchange_count,teb.uid,teb.franchisee_id,teb.physics_status,teb.business_status,tec.cell_no,temc.due_time_total as 'memberCardExpireTime'
        from t_electricity_battery teb left join t_car_rental_package_member_term temc on teb.uid=temc.uid
        left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId} and teb.uid is not null and temc.del_flag=0 and temc.due_time_total >0 and temc.rental_package_type=2
        and teb.business_status =2
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.currentTimeMillis != null">
            and temc.due_time_total <![CDATA[ < ]]> #{query.currentTimeMillis}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="query.sort == 0">
            order by temc.due_time_total desc
        </if>
        <if test="query.sort == 1">
            order by temc.due_time_total
        </if>
        limit #{offset}, #{size}
    </select>
    <select id="queryOverdueCarBatteryCount" resultType="java.lang.Integer">
        select count(1)
        from t_electricity_battery teb left join t_car_rental_package_member_term temc on teb.uid=temc.uid
        left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId} and teb.uid is not null and temc.del_flag=0 and temc.due_time_total >0 and temc.rental_package_type=2
        and teb.business_status =2
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.currentTimeMillis != null">
            and temc.due_time_total <![CDATA[ < ]]> #{query.currentTimeMillis}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
    </select>
    <select id="queryStockBatteryList" resultType="com.xiliulou.electricity.vo.ElectricityBatteryDataVO">
        select teb.id,teb.sn,teb.longitude,teb.latitude,teb.power,teb.voltage,teb.capacity as
        dbCapacity,teb.model,teb.status,teb.electricity_cabinet_id,teb.electricity_cabinet_name,
        teb.user_name,teb.create_time,teb.update_time,teb.del_flag,teb.charge_status,teb.health_status,teb.tenant_id,teb.borrow_expire_time,tbop.battery_v as boxVoltage,
        teb.iot_card_number,teb.exchange_count,teb.uid,teb.franchisee_id,teb.physics_status,teb.business_status,tec.cell_no
        from t_electricity_battery teb left join t_user_battery_member_card temc on teb.uid=temc.uid
        left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        and teb.physics_status =1 and teb.business_status =1
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        -- 电池，柜机，加盟商，通用搜索
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        order by teb.create_time desc
        limit #{offset}, #{size}
    </select>
    <select id="queryStockBatteryCount" resultType="java.lang.Integer">
        select count(1)
        from t_electricity_battery teb left join t_user_battery_member_card temc on teb.uid=temc.uid
        left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        left join t_battery_other_properties tbop on tbop.battery_name =teb.sn and tbop.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        and teb.physics_status =1 and teb.business_status =1
        <if test="query.physicsStatus != null">
            and teb.physics_status =#{query.physicsStatus}
        </if>
        <if test="query.businessStatus != null and query.businessStatus.size()>0">
            and teb.business_status in
            <foreach collection="query.businessStatus" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="query.Sns != null and query.Sns.size()>0">
            and teb.sn in
            <foreach collection="query.Sns" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        -- 电池，柜机，加盟商，通用搜索
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.electricityCabinetId != null">
            and teb.electricity_cabinet_id =#{query.electricityCabinetId}
        </if>
        <if test="query.franchiseeId != null">
            and teb.franchisee_id =#{query.franchiseeId}
        </if>
        <if test="query.uid != null">
            and teb.uid = #{query.uid}
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        order by teb.create_time desc
    </select>
    
    <select id="existBySn" resultType="Integer">
        select 1
        from t_electricity_battery
        where del_flag = 0
          and sn = #{sn} limit 1
    </select>
    
    <select id="selectListSnByFranchiseeId" resultType="com.xiliulou.electricity.bo.asset.ElectricityBatteryBO">
        <include refid="selectElectricityBattery"/>
        where del_flag = 0 and tenant_id = #{tenantId}
        <if test="franchiseeId != null">
            and franchisee_id = #{franchiseeId}
        </if>
        <if test="stockStatus != null">
            and stock_status = #{stockStatus}
        </if>
        <if test="sn != null and sn != ''">
            and sn like concat('%',#{sn,jdbcType=VARCHAR},'%')
        </if>
        order by id desc
        <if test="offset != null and size != null">
            limit #{offset}, #{size}
        </if>
    </select>
    
    <select id="existsByWarehouseId" resultType="java.lang.Integer">
        select 1 from t_electricity_battery where warehouse_id = #{wareHouseId} and del_flag = 0 and stock_status=0 limit 1;
    </select>
    
    <select id="selectListEnableAllocateBattery" resultType="com.xiliulou.electricity.bo.asset.ElectricityBatteryBO">
        <include refid="selectElectricityBattery"/>
        <where>
            del_flag = 0 and tenant_id = #{tenantId} and franchisee_id = #{franchiseeId}
            and business_status in
            <foreach collection="businessStatusList" item="businessStatus" index="index" open="(" close=")" separator=",">
                #{businessStatus}
            </foreach>
            <if test="idList != null and idList.size()>0">
                and id in
                <foreach collection="idList" item="id" index="index" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="sn != null and sn != ''">
                and sn like concat('%',#{sn,jdbcType=VARCHAR},'%')
            </if>
        </where>
        order by id
        <if test="offset != null and size!= null">
            limit #{offset}, #{size}
        </if>
    </select>
    
    <select id="selectListEnableExitWarehouseBattery" resultType="com.xiliulou.electricity.bo.asset.ElectricityBatteryBO">
        <include refid="selectElectricityBattery"/>
        <where>
            del_flag=0 and tenant_id = #{tenantId}
            <if test="franchiseeId != null">
                and franchisee_id = #{franchiseeId}
            </if>
            <if test="stockStatus != null">
                and stock_status = #{stockStatus}
            </if>
            <if test="idSet != null and idSet.size()>0">
                and id in
                <foreach collection="idSet" item="id" index="index" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
            <if test="snList != null and snList.size()>0">
                and sn in
                <foreach collection="snList" item="sn" index="index" open="(" close=")" separator=",">
                    #{sn}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectListByIdList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        SELECT
            id,
            sn
        FROM
            t_electricity_battery
        where
            del_flag = 0
          and id in
          <foreach collection="idList" separator="," open="(" close=")" item="id">
              #{id}
          </foreach>
    </select>
    <select id="selectListBySnArray" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select id,sn from t_electricity_battery where del_flag=0
        <if test="tenantId != null">
            and tenant_id = #{tenantId}
        </if>
        <if test="franchiseeId != null">
            and franchisee_id = #{franchiseeId}
        </if>
        <if test="list != null">
            and sn IN(
            <foreach collection="list" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
    </select>
    
    <select id="selectListBatteriesBySn" resultType="com.xiliulou.electricity.vo.ElectricityBatteryVO">
        SELECT
            id,
            sn
        FROM
            t_electricity_battery
        <where>
            del_flag = 0
            and tenant_id = #{tenantId}
            <if test="franchiseeId != null">
                and franchisee_id = #{franchiseeId}
            </if>
            <if test="sn != null and sn !=''">
                and sn like concat('%',#{sn,jdbcType=VARCHAR},'%')
            </if>
        </where>
        limit #{offset}, #{size}
    </select>
    
    
    
    <select id="selectListBatteriesByFranchisee" resultType="com.xiliulou.electricity.vo.ElectricityBatteryVO">
        SELECT
        id,
        sn
        FROM
        t_electricity_battery
        where
        del_flag = 0
        and tenant_id = #{tenantId}
        and franchisee_id in
        <foreach collection="franchiseeIds" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
        <if test="sn != null and sn !=''">
            and sn like concat('%',#{sn,jdbcType=VARCHAR},'%')
        </if>
        limit #{offset}, #{size}
    </select>
    
    <select id="selectListByEid" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        SELECT
        id,sn,charge_status,electricity_cabinet_id
        FROM
        t_electricity_battery
        where
        del_flag = 0
        and electricity_cabinet_id in
        <foreach collection="eIdList" separator="," open="(" close=")" item="id">
            #{id}
        </foreach>
    </select>
    
    <select id="existsByBatteryType" resultType="java.lang.Integer">
        select 1 from t_electricity_battery where del_flag = 0 and tenant_id = #{tenantId} and model = #{batteryType} limit 1;
    </select>
    
    <update id="batchExitWarehouse">
        update t_electricity_battery
        <set>
            stock_status = 0,
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            warehouse_id = #{warehouseId}
        </set>
        where tenant_id = #{tenantId} and franchisee_id = #{franchiseeId} and id in
        <foreach collection="idList" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>
    
    <update id="updateFranchiseeId">
        update t_electricity_battery set franchisee_id = #{targetFranchiseeId}, update_time = #{updateTime} where id = #{id} and franchisee_id = #{sourceFranchiseeId}
    </update>


    <select id="selectMutualBattery" resultType="com.xiliulou.electricity.bo.ExportMutualBatteryBO">
        select teb.sn as sn, teb.franchisee_id as franchiseeId,teb.business_status as businessStatus, tf.name as franchiseeName,
        teb.physics_status,
        tec.franchisee_id as eFranchiseeId,
        tec.name as electricityCabinetName
        , tecb.cell_no as cellNo
        ,tui.franchisee_id as userFranchiseeId
        , tui.name as userName
        , tui.phone
        from t_electricity_battery teb
        left join t_franchisee tf on teb.franchisee_id = tf.id
        left join t_electricity_cabinet tec on tec.id =teb.electricity_cabinet_id and tec.del_flag =0
        left join t_electricity_cabinet_box tecb on teb.sn = tecb.sn and tec.id=tecb.electricity_cabinet_id
        left join t_user_info tui on teb.uid = tui.uid
        where teb.del_flag = 0
        and teb.tenant_id = #{tenantId} and teb.business_status in(2,3)
        <if test="franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="franchiseeIds" item="id" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
    </select>
    
    <select id="selectLUserBatteryByUidList" resultType="com.xiliulou.electricity.entity.ElectricityBattery">
        select sn, model, create_time, uid
        FROM t_electricity_battery
        where del_flag = 0 and tenant_id = #{tenantId} and uid in
        <foreach collection="uidList" item="uid" open="(" close=")" separator=",">
            #{uid}
        </foreach>
    </select>
    
    <select id="selectListAllBatterySn" resultType="com.xiliulou.electricity.vo.battery.BatterySnVO">
        select teb.sn
        from t_electricity_battery teb left join t_electricity_cabinet_box tec on teb.sn=tec.sn and teb.electricity_cabinet_id=tec.electricity_cabinet_id and tec.del_flag = 0
        where teb.del_flag = 0 and teb.tenant_id = #{query.tenantId}
        <if test="query.sn != null and query.sn !=''">
            and teb.sn like concat('%',#{query.sn,jdbcType=VARCHAR},'%')
        </if>
        <if test="query.franchiseeIds != null">
            and teb.franchisee_id in
            <foreach collection="query.franchiseeIds" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        order by teb.create_time desc
        limit #{query.offset}, #{query.size}
    </select>


</mapper>
