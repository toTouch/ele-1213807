<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiliulou.electricity.mapper.merchant.MerchantPlaceMapMapper">
    <insert id="batchInsert">
        insert into t_merchant_place_map(merchant_id , place_id , tenant_id , del_flag, create_time, update_time)
        values
        <foreach item="item" index="index" collection="list" separator=",">
            (#{item.merchantId}, #{item.placeId}, #{item.tenantId}, #{item.delFlag}, #{item.createTime}, #{item.updateTime})
        </foreach>
    </insert>
    <delete id="batchDeleteByMerchantId">
        delete from t_merchant_place_map
       <where>
           merchant_id = #{merchantId}
           <if test="placeIdList != null and placeIdList.size() > 0">
               and place_id in
               <foreach collection="placeIdList" separator="," open="(" close=")" item="placeId">
                   #{placeId}
               </foreach>
           </if>
       </where>
       
    </delete>
    
    <select id="list" resultType="com.xiliulou.electricity.entity.merchant.MerchantPlaceMap">
        SELECT
        place_id,
        merchant_id
        FROM
        t_merchant_place_map
        where del_flag = 0
        <if test="placeIdList != null and placeIdList.size() > 0">
            and place_id in
            <foreach collection="placeIdList" item="placeId" close=")" open="(" separator=",">
                #{placeId}
            </foreach>
        </if>
       
        <if test="merchantId != null">
            <if test="eqFlag != null and  eqFlag == 0">
                and merchant_id != #{merchantId}
            </if>
            
            <if test="eqFlag != null and  eqFlag == 1">
                and merchant_id = #{merchantId}
            </if>
        </if>
        
        <if test="merchantIdList != null and merchantIdList.size() > 0">
            and merchant_id in
            <foreach collection="merchantIdList" item="merchantId" close=")" open="(" separator=",">
                #{merchantId}
            </foreach>
        </if>

        
    </select>
    <select id="selectListByMerchantId" resultType="com.xiliulou.electricity.vo.merchant.MerchantPlaceSelectVO">
        SELECT
            place_id,
            merchant_id,
            p.`name` as 'placeName'
        FROM
            t_merchant_place_map m
                left join t_merchant_place p on p.id = m.place_id
        WHERE
           m.merchant_id = #{merchantId}
    </select>
    
    <select id="selectBindList" resultType="com.xiliulou.electricity.entity.merchant.MerchantPlaceMap">
        SELECT
            place_id,
            merchant_id
        FROM
            t_merchant_place_map m
                LEFT JOIN t_merchant_place p ON p.id = m.place_id
        <where>
            m.del_flag = 0
            <if test="franchiseeId != null">
                and p.franchisee_id = #{franchiseeId}
            </if>
            <if test="notMerchantId != null">
                and m.merchant_id != #{notMerchantId}
            </if>
            
        </where>
        
    </select>
    
    <select id="selectBindMerchantName" resultType="com.xiliulou.electricity.vo.merchant.MerchantPlaceMapVO">
        SELECT
            m.place_id,
            m.merchant_id,
            t.`name` as 'merchantName'
        FROM
            t_merchant_place_map m
                left join t_merchant t on t.id = m.merchant_id
    
        where
          m.del_flag = 0
          <if test="placeIdList != null">
              and place_id in
              <foreach collection="placeIdList" separator="," open="(" close=")" item="placeId">
                  #{placeId}
              </foreach>
          </if>
    </select>
    
    <select id="countByMerchantIdList" resultType="com.xiliulou.electricity.vo.merchant.MerchantPlaceMapVO">
        SELECT
            merchant_id,
            count( 1 ) as 'count'
        FROM
            t_merchant_place_map
        WHERE
            del_flag = 0
          AND merchant_id IN
        <foreach collection="merchantIdList" separator="," open="(" close=")" item="merchantId">
            #{merchantId}
        </foreach>
        GROUP BY
            merchant_id
    </select>
    
    <select id="selectCabinetIdsByMerchantId" resultType="java.lang.Long">
        SELECT
            DISTINCT b.cabinet_id
        FROM
            t_merchant_place_map a
                left join t_merchant_place_cabinet_bind b on b.place_id = a.place_id
        where
            a.merchant_id = #{merchantId}
          and b.`status` = 1
          and b.del_flag = 0;
    </select>
    
    <select id="existsPlaceFeeByPlaceIdList" resultType="java.lang.Integer">
        SELECT
            count( 1 )
        FROM
            t_merchant_place_cabinet_bind d
        WHERE
            d.place_id in
            <foreach collection="placeIdList" separator="," open="(" close=")" item="placeId">
                #{placeId}
            </foreach>
          AND d.`status` = 0
          AND EXISTS (
            SELECT
                1
            FROM
                t_electricity_cabinet c
            WHERE
                c.id = d.cabinet_id
              AND c.place_fee IS NOT NULL)
    </select>
    
    <select id="queryListNoExistsPlaceFeeMerchant" resultType="java.lang.Long">
        SELECT
            p.id
        FROM
            t_merchant_place_map p
                left join t_merchant m on m.id = p.merchant_id
        where
            p.place_id = #{placeId}
          and m.exist_place_fee = 1
    </select>
    
    <select id="selectListNoExistsPlaceFeeMerchantByCabinetId" resultType="java.lang.Long">
        SELECT
            p.id
        FROM
            t_merchant_place_cabinet_bind a
                INNER JOIN  t_merchant_place_map m on m.place_id = a.place_id
                INNER JOIN  t_merchant p on p.id = m.merchant_id
        where
            a.`status` = 0
          and p.exist_place_fee = 1
          and a.cabinet_id in
          <foreach collection="cabinetIdList" separator="," open="(" close=")" item="cabinetId">
              #{cabinetId}
          </foreach>
    </select>
</mapper>
